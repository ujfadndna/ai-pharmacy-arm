# 机械臂系统延迟预算文档

## 1. 系统延迟预算表

| 环节 | 预算(ms) | 实际(ms) | 状态 | 备注 |
|------|----------|----------|------|------|
| 运动控制周期 | 5 | 5 | ✓ | GPT0定时器中断驱动 |
| CAN发送 | 1 | <1 | ✓ | 单帧发送时间 |
| CAN超时检测 | 500 | 500 | ✓ | 电机失联判定阈值 |
| 碰撞检测周期 | 20 | 20 | ✓ | 堵转检测采样间隔 |
| 看门狗超时 | 2700 | 2700 | ✓ | IWDG复位阈值 |
| LLM响应 | 15000 | 5000-15000 | ✓ | 网络延迟波动 |

## 2. 关键路径分析

### 2.1 运动控制闭环

```
时序图 (单位: ms)

    0        1        2        3        4        5        6
    |--------|--------|--------|--------|--------|--------|
    [GPT0中断]
         [motion_update()]
              [轨迹插值]
                   [CAN发送]
                        [电机响应]
                             [下一周期]
    |<-------------- 5ms 周期 -------------->|
    |<---------------- 6ms deadline ---------------->|
```

**路径详情:**
1. GPT0中断触发 (T=0)
2. motion_update() 计算目标位置 (~0.5ms)
3. 轨迹插值与速度规划 (~0.3ms)
4. CAN帧发送至电机 (~0.8ms)
5. 电机响应并执行 (~2ms)
6. 预留裕量 (~1.4ms)

### 2.2 碰撞检测闭环

```
时序图 (单位: ms)

    0       20       40       60       80      100
    |--------|--------|--------|--------|--------|
    [采样1]  [采样2]  [采样3]  [检测触发]
                               |
                               v
                          [急停/降级]
                               |
                               v
                          [电机停止]
    |<------------ 100ms 软实时 deadline ----------->|
```

**路径详情:**
1. 周期性采样电机电流/位置 (20ms间隔)
2. 连续3次异常判定为堵转 (~60ms)
3. 触发急停或降级策略 (~5ms)
4. 电机制动停止 (~30ms)

### 2.3 LLM交互闭环

```
时序图 (单位: s)

    0     1     2     3     4     5    ...    15
    |-----|-----|-----|-----|-----|-----|-----|
    [语音输入]
          [ASR处理]
                [LLM推理]
                      .....
                           [动作解析]
                                [执行]
    |<------------- 15s 用户可接受 ------------->|
```

**路径详情:**
1. 语音输入采集 (~1s)
2. ASR语音识别 (~0.5s)
3. LLM推理响应 (5-12s, 网络依赖)
4. 动作指令解析 (~0.1s)
5. 运动控制执行 (进入实时闭环)

## 3. 实时性要求

| 类别 | 实时等级 | Deadline | 违约后果 | 保障机制 |
|------|----------|----------|----------|----------|
| 运动控制 | 硬实时 | 6ms | 轨迹抖动/失步 | GPT0中断+最高优先级 |
| 碰撞检测 | 软实时 | 100ms | 碰撞损坏风险 | 独立任务+降级策略 |
| LLM交互 | 非实时 | 15s | 用户体验下降 | 超时提示+本地缓存 |

### 3.1 优先级分配

```
优先级 (数值越小越高)

    0  [GPT0中断]     - 运动控制, 不可抢占
    1  [CAN接收中断]  - 电机反馈
    2  [碰撞检测任务] - 安全保护
    3  [通信任务]     - LLM/串口
    4  [空闲任务]     - 看门狗喂狗
```

## 4. 监控命令

### 4.1 运动控制监控

```shell
# 查看运动控制周期统计
> rtmon
Motion Control Statistics:
  Period: 5.00ms (target: 5ms)
  Jitter: 0.12ms (max: 0.35ms)
  Overrun: 0 times
  CPU: 12.3%
```

### 4.2 任务监控

```shell
# 查看CPU占用
> taskmon
Task Monitor:
  NAME            STATE   PRI   CPU%   STACK
  MotionCtrl      RUN     0     12.3   256/512
  CollisionDet    READY   2     3.1    128/256
  Communication   BLOCK   3     8.7    512/1024
  IDLE            READY   4     75.9   64/128
```

### 4.3 降级状态

```shell
# 查看降级状态
> degrade
Degrade Status:
  Level: NORMAL
  Motor[0]: OK (current: 0.8A)
  Motor[1]: OK (current: 1.2A)
  Motor[2]: OK (current: 0.5A)
  CAN Bus: OK (error: 0)
  LLM: OK (latency: 3200ms)
```

## 5. 风险与缓解

### 5.1 风险矩阵

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| CAN总线拥塞 | 中 | 高 | 降低发送频率, 优先级仲裁 |
| LLM响应超时 | 高 | 低 | 本地缓存常用指令, 超时提示 |
| 电机失联 | 低 | 高 | 降级策略, 安全位置回退 |
| 看门狗复位 | 低 | 中 | 多点喂狗, 状态保存 |

### 5.2 缓解策略详情

**CAN总线拥塞:**
```
正常模式:  200Hz发送 (5ms周期)
拥塞检测:  错误帧计数 > 10/s
降级模式:  100Hz发送 (10ms周期)
恢复条件:  错误帧计数 < 2/s 持续5s
```

**LLM响应慢:**
```
本地缓存指令:
  - "回到原点" -> home_position()
  - "停止"     -> emergency_stop()
  - "抓取"     -> grip_action()

超时处理:
  - 5s:  显示等待提示
  - 10s: 显示重试选项
  - 15s: 自动取消, 提示网络问题
```

**电机失联:**
```
检测条件:  CAN反馈超时 > 500ms
降级等级:
  L1: 单电机失联 -> 锁定该关节, 其他继续
  L2: 多电机失联 -> 全臂急停
  L3: CAN总线故障 -> 安全位置回退
```

## 6. 性能基准

### 6.1 测试环境

- MCU: STM32F103 @ 72MHz
- CAN: 1Mbps
- 电机: 3轴步进/伺服
- 网络: WiFi 2.4GHz

### 6.2 基准数据

```
运动控制周期抖动分布:

  Count
    |
  50|    ****
  40|   ******
  30|  ********
  20| **********
  10|************
    +--+--+--+--+--+---> Jitter(ms)
      0.0 0.1 0.2 0.3 0.4 0.5

  Mean: 0.12ms  Max: 0.35ms  99%: 0.28ms
```

---

*文档版本: 1.0*
*更新日期: 2026-02-17*
